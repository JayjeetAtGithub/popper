#!/bin/bash
set -ex
# shellcheck source=./ci/test/common
source ./common
init_test_repo
cd "$test_repo_path"

export PHONY_SECRET=12345

git clone https://github.com/cplee/github-actions-demo
pushd github-actions-demo
popper run --runtime "$RUNTIME"
popd
sudo rm -rf github-actions-demo

mkdir spack-workflow
cat <<EOF > spack-workflow/main.workflow
workflow "Install and run LULESH" {
  on = "push"
  resolves = "run lulesh"
}

action "install" {
  uses = "popperized/spack@master"
  args = "install lulesh~mpi cppflags=-static cflags=-static"
}

action "create view" {
  needs = "install"
  uses = "popperized/spack@master"
  args = "view -d yes hard -i ./install/ lulesh~mpi "
}

action "run lulesh" {
  needs = "create view"
  uses = "docker://debian:buster-slim"
  runs = ["sh", "-c", "install/bin/lulesh2.0 -s 100 -i 10"]
}
EOF

popper run --wfile spack-workflow/main.workflow --runtime "$RUNTIME"
sudo rm -rf spack-workflow